<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Post - Forum</title>
    <link rel="icon" href="../static/public/favicon.png" type="image/png" />
    <link rel="stylesheet" href="../static/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="navbar-placeholder"></div>

    <div class="container">
      <div class="form-container" style="max-width: 800px">
        <h1 style="margin-bottom: 2rem">Create Post</h1>
        <form method="post" id="create-post-form" enctype="multipart/form-data">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" required name="title" maxlength="50"/>
            <div id="customTitleError"></div>
          </div>
          <div class="form-group">
            <label for="category">Category</label>
            {{if .}}
              <select id="categories">
                {{range .}}
                <option value="{{.CategoryName}}">{{.CategoryName}}</option>
                {{end}}
              </select>
            {{end}}
            <input type="text" id="category"  maxlength="50"/> <!--//name="category"-->
            <button id="addButton" disabled>Add +</button>
            <div id="customCatError"></div>
            <label>Selected categories</label> 
            <input type="text" name="categories" id="postCategories" hidden />
            <div id="selectedCatDiv"></div>
          </div>
          <div class="form-group">
            <label for="content">Content</label>
            <textarea id="content" rows="10" name="content" maxlength="1200" required></textarea>
          </div>
          <div class="form-group">
            <label for="image">Image (optional)</label>
            <input type="file" id="image" name="post_image" accept="image/*" />
          </div>
          <button type="submit" class="btn btn-primary" id="submitButton">Create Post</button>
        </form>
      </div>
    </div>

    <script src="../static/utils/theme.js"></script>
    <script type="module">
      let selectedCategories = new Set()
      console.log(document.getElementById('categories'))
      if (document.getElementById('categories')) {
        document.getElementById('categories').addEventListener('click', (event) => {
          selectedCategories.add(event.target.value)
          document.getElementById('selectedCatDiv').innerHTML = [...selectedCategories].join(' ')
          document.getElementById('postCategories').value = [...selectedCategories].join(' ')
        })
      }
      

      // console.log(document.getElementById('categories'))
      document.getElementById('addButton').addEventListener('click', (e)=>{
        e.preventDefault()
        console.log(document.getElementById('category').value)
        selectedCategories.add("#" + document.getElementById('category').value)
        document.getElementById('selectedCatDiv').innerHTML = [...selectedCategories].join(' ')
        document.getElementById('postCategories').value = [...selectedCategories].join(' ')
      })
      
    </script>
    <script>
        const postImage = document.getElementById("image");

        postImage.addEventListener("change", (event) => {
          const file = event.target.files[0];

          // Validate the file (optional)
          if (file) {
            if (!file.type.startsWith("image/")) {
              alert("Please select a valid image file.");
              postImage.value = ""; // Reset the input
              return;
            }

            if (file.size > 20 * 1024 * 1024) {
              // 2MB limit
              alert("File size exceeds 20MB. Please choose a smaller file.");
              postImage.value = ""; // Reset the input
              return;
            }
          }
        });
    </script>

    <script type="module">
      const category = document.getElementById('category')
      const title = document.getElementById('title')
      const catRegex = /^[a-zA-Z0-9-_]{1,50}$/

      const catError = document.getElementById('customCatError')
      const titleError = document.getElementById('customTitleError')

      const addButton = document.getElementById('addButton')
      const submitButton = document.getElementById('submitButton')

      category.addEventListener('input', (event) => {
        if (catRegex.test(event.target.value)) {
          catError.innerText = ""
          addButton.disabled = false
        } else {
          catError.innerText = "Invalid category"
          addButton.disabled = true
        }
      })

      title.addEventListener('input', (event) => {
        if (catRegex.test(event.target.value)) {
          titleError.innerText = ""
          submitButton.disabled = false
        } else {
          titleError.innerText = "Invalid title"
          submitButton.disabled = true
        }
      })
    </script>
  </body>
</html>
